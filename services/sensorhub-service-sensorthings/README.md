## SensorThings API Add-On for OSH

This module deploys a servlet implementing [OGC SensorThings API v1.0](https://www.opengeospatial.org/standards/sensorthings).

The implementation is based on [FROST Server](https://github.com/FraunhoferIOSB/FROST-Server) developped by Fraunhofer IOSB, and currently complies with the following conformance classes of the standard:

- A.1 SensorThings Read (Core)
- A.2 SensorThings API Filtering Extension (still under development)
- A.3 SensorThings API Create-Update-Delete Extension
- A.5 SensorThings API MultipleDatastream
- A.6 SensorThings API Data Array Extension

A separate module will implement the MQTT extensions with a goal of complying with:

- A.7 SensorThings API Observation Creation via MQTT Extension Tests
- A.8 SensorThings API Receiving Updates via MQTT Extension Tests



#### Sensor/Procedure Registration

The SensorThings API is a transactional service, and as such allows the registration of new procedures. 

New *Sensors* entities created via this service are exposed to the rest of the hub just like any other procedure in OSH. They are registered with the hub's *Procedure Registry* and can publish events to the *Event Bus*.

New *Datastream* entities created via this service and attached to a previously registered *Sensor* are advertised as a new procedure output. An event is sent to the event bus every time a datastream is added/updated/removed to signal that the procedure has changed.

New *Observation* entities created via this service and attached to a previously registered *Datastream* also result in a "New Data Event" being published to the *Event Bus*. The event is published in the channel for the procedure output corresponding to the attached *Datastream*.



#### Interaction with other Procedures

This service can also be configured to expose other sensors/procedures connected to the hub (i.e. the ones not registered via this service) in read-only mode. This is done by listing individual procedure UIDs, procedure group UIDs or UID prefixes in the configuration:

```
...
  "exposedProcedures": [
    "urn:example1:uid-sensor1",
    "urn:example1:uid-sensor2",
    "urn:example1:uid-group1",
    "urn:example2:*"
  ]
...
```

When a group UID is included, the group  as well as all procedures from this group are exposed through the API. 

When a UID prefix is used (i.e. with a trailing *), all procedures whose UID starts with the specified prefix will be exposed. (Note that arbitrary wildcard positions are not supported. The wildcard character can only be used at the end, thus corresponding to matching a prefix).

Exposing a procedure means that the procedure will be visible through the SensorThings API as a *Sensor* entity. All procedure outputs will be visible as *Datastream* or *MultiDatastream* entities, and observations generated by the procedure will be  



#### SensorThings Entity Database

The service comes with a built-in embedded database based on H2 MVStore, but the database is also defined as an interface so that more DB connectors can be implemented. The database is configured via the `dbConfig` configuration section:

```
...
  "dbConfig": {
    "objClass": "org.sensorhub.impl.service.sta.STADatabaseConfig",
    "moduleClass": "org.sensorhub.impl.service.sta.MVSTADatabase",
    "databaseID": 3,
    "storagePath": "sta_db.dat",
    "memoryCacheSize": 1024,
    "autoCommitBufferSize": 1024,
    "useCompression": false
  }
...
```

The service can also be configured to use an external *Observation Database*. An *Observation Database* is a standard type of database defined by the OSH core models that can handle *Sensor*, *Datastream*, *Observation* and *FeatureOfInterest* entities:

```
...
  "dbConfig": {
    ...
    "externalObsDatabaseID": "other_database_module_ID",
    ...
  }
...
```

When using an external observation database, all other entities (i.e. *Things*, *Locations*, *ObservedProperties*) are still stored in the dedicated SensorThings database.

The point of using an external *Observation Database* is that it can be shared with other OSH modules such as the SOS Service. When configured this way, OSH can act as a gateway between SensorThings API and Sensor Observation Service interfaces, with full transactional support (create/read/update/delete) on both side.

Note that, if not sharing the database, it is also possible to configure the hub as a gateway where each service (e.g. SensorThings or SOS) can create/update/delete its own procedures and expose them only as read-only to the other.

